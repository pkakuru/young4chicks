{% extends 'sales/base.html' %}
{% load humanize %}

{% block title %}Farmer Request History | Young4ChickS{% endblock %}

{% block content %}
<h2>📄 Farmer Request History</h2>
<p class="text-muted">Search for a registered farmer by name or NIN to view all chick and feed requests.</p>

<!-- Search -->
<form method="GET" class="mb-4">
  <div class="row g-3">
    <div class="col-md-9">
      <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="Enter Farmer Name or NIN..." required>
    </div>
    <div class="col-md-3">
      <button type="submit" class="btn btn-primary w-100">🔍 Search</button>
    </div>
  </div>
</form>

{% if farmer %}
<!-- Farmer Details -->
<div class="card p-3 mb-4">
  <h5 class="mb-3">👤 Farmer: {{ farmer.name }}</h5>
  <div class="row">
    <div class="col-md-4">
      <p><strong>DOB:</strong> {{ farmer.dob|date:"M d, Y" }}</p>
      <p><strong>Gender:</strong> {{ farmer.gender|capfirst }}</p>
    </div>
    <div class="col-md-4">
      <p><strong>NIN:</strong> {{ farmer.nin }}</p>
      <p><strong>Contact:</strong> {{ farmer.contact }}</p>
    </div>
    <div class="col-md-4">
      <p><strong>Recommender:</strong> {{ farmer.recommender|default:"—" }}</p>
      <p><strong>Rec. NIN:</strong> {{ farmer.recommender_nin|default:"—" }}</p>
    </div>
  </div>
</div>

<!-- Chick Requests -->
<div class="card p-3 mb-4">
  <h5 class="mb-3">🐥 Chick Request History</h5>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Type</th>
          <th>Quantity</th>
          <th>Status</th>
          <th>Picked?</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for r in chick_requests %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ r.submitted_on|date:"M d, Y" }}</td>
          <td>{{ r.chick_type|cut:"_"|title }}</td>
          <td>{{ r.quantity|intcomma }}</td>
          <td>
            {% if r.status == 'approved' %}
              <span class="badge bg-success badge-fixed">Approved</span>
            {% elif r.status == 'pending' %}
              <span class="badge bg-warning text-dark badge-fixed">Pending</span>
            {% else %}
              <span class="badge bg-danger badge-fixed">Rejected</span>
            {% endif %}
          </td>
          <td>
            {% if r.is_picked %}
              ✅ ({{ r.picked_on|date:"M d" }})
            {% else %}
              ❌
            {% endif %}
          </td>
          <td>{{ r.notes|default:"—" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-center text-muted">No chick requests found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Feed Requests -->
<div class="card p-3">
  <h5 class="mb-3">🌾 Feed Request History</h5>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Feed Type</th>
          <th>Bags</th>
          <th>Status</th>
          <th>Picked?</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for r in feed_requests %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ r.request_date|date:"M d, Y" }}</td>
          <td>{{ r.feed_type|capfirst }}</td>
          <td>{{ r.quantity_bags|intcomma }}</td>
          <td>
            {% if r.status == 'approved' %}
              <span class="badge bg-success badge-fixed">Approved</span>
            {% elif r.status == 'pending' %}
              <span class="badge bg-warning text-dark badge-fixed">Pending</span>
            {% else %}
              <span class="badge bg-danger badge-fixed">Rejected</span>
            {% endif %}
          </td>
          <td>
            {% if r.is_picked %}
              ✅ ({{ r.picked_on|date:"M d" }})
            {% else %}
              ❌
            {% endif %}
          </td>
          <td>{{ r.notes|default:"—" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-center text-muted">No feed requests found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% elif query %}
<div class="alert alert-warning">No farmer found matching "<strong>{{ query }}</strong>".</div>
{% endif %}

{% endblock %}

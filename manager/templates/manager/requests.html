{% extends 'manager/base.html' %}
{% block title %}Chick Stock{% endblock %}
{% block content %}
<h2>üì• Chick Requests</h2>
<p class="text-muted">Review pending requests and view approval history.</p>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" id="requestTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="pending-tab" data-toggle="tab" href="#pending" role="tab">‚è≥ Pending Requests</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="approved-tab" data-toggle="tab" href="#approved" role="tab">‚úÖ Approved / Picked</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab">üìú All History</a>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="requestTabsContent">

    <!-- Pending Requests Tab -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endfor %}
    {% endif %}


    <div class="tab-pane fade show active" id="pending" role="tabpanel">
        <div class="card p-3 mb-4">
            <h5 class="mb-3">‚è≥ Pending Chick Requests</h5>

            <div class="mb-3">
                <input type="text" class="form-control" placeholder="Search by farmer name, NIN, or request ID...">
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th>Request ID</th>
                            <th>Farmer</th>
                            <th>NIN</th>
                            <th>Type</th>
                            <th>Qty</th>
                            <th>Farmer Type</th>
                            <th>Submitted On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in pending_requests %}
                        <tr>
                            <td class="align-middle">#REQ{{ request.id }}</td>
                            <td class="align-middle">{{ request.farmer.name }}</td>
                            <td class="align-middle">{{ request.farmer.nin }}</td>
                            <td class="align-middle">{{ request.chick_type|title }}</td>
                            <td class="align-middle">{{ request.quantity }}</td>
                            <td class="align-middle">{{ request.farmer.farmer_type|title }}</td>
                            <td class="align-middle">{{ request.submitted_on|date:"M d, Y" }}</td>
                            <td class="align-middle">
                                <form method="post" action="{% url 'approve_reject_request' request.id %}"
                                    style="display:inline-block;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="approve">
                                    <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                </form>
                                <form method="post" action="{% url 'approve_reject_request' request.id %}"
                                    style="display:inline-block;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="reject">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Reject</button>
                                </form>
                            </td>

                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted">No pending requests found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>

        </div>
    </div>

    <!-- Approved / Picked Requests Tab -->
    <div class="tab-pane fade" id="approved" role="tabpanel">
        <div class="card p-3 mb-4">
            <h5 class="mb-3">‚úÖ Approved & Picked Requests</h5>

            <div class="mb-3">
                <input type="text" class="form-control" placeholder="Search by farmer name, NIN, or date...">
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="thead-light">
                        <tr>
                            <th>Request ID</th>
                            <th>Farmer</th>
                            <th>Type</th>
                            <th>Qty</th>
                            <th>Status</th>
                            <th>Picked On</th>
                            <th>Pickup Notes</th>
                            <th>Approved On</th>
                            <!-- <th>Approved By</th> -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in approved_requests %}
                        <tr>
                            <td>#REQ{{ request.id }}</td>
                            <td>{{ request.farmer.name }}</td>
                            <td>{{ request.chick_type|title }}</td>
                            <td>{{ request.quantity }}</td>

                            <!-- Status shows Picked vs Approved -->
                            <td>
                                {% if request.is_picked %}
                                <span class="badge badge-primary badge-fixed">Picked</span>
                                {% else %}
                                <span class="badge badge-success badge-fixed">Approved</span>
                                {% endif %}
                            </td>

                            <!-- Picked date -->
                            <td>
                                {% if request.is_picked %}
                                {{ request.picked_on|date:"M d, Y" }}
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>

                            <!-- Pickup notes -->
                            <td>
                                {% if request.pickup_notes %}
                                {{ request.pickup_notes }}
                                {% else %}
                                <em class="text-muted">‚Äî</em>
                                {% endif %}
                            </td>

                            <td>{{ request.approval_date|date:"M d, Y" }}</td>

                            <!-- Guard approved_by possibly being None -->
                            <!-- <td>
                                {% if request.approved_by %}
                                {{ request.approved_by.get_full_name|default:request.approved_by.username }}
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td> -->
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">No approved requests yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>


                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- All History Tab -->
    <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="card p-3 mb-4">
            <h5 class="mb-3">üìú All Request History</h5>

            <div class="mb-3">
                <input type="text" class="form-control" placeholder="Search all records...">
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="thead-light">
                        <tr>
                            <th>Farmer</th>
                            <th>Chick Type</th>
                            <th>Qty</th>
                            <th>Chicks (UGX)</th>
                            <th>Picked?</th>
                            <th>Feeds</th>
                            <th>Notes</th>
                            <th>Submitted On</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in history_requests %}
                        <tr>
                            <td class="align-bottom">{{ request.farmer.name }}</td>
                            <td class="align-bottom">{{ request.chick_type|title }}</td>
                            <td class="align-bottom">{{ request.quantity }}</td>

                            {# Expected / Paid / Balance #}
                            <td>
                                <div>Expected: <strong>UGX {{ request.expected_chicks_amount|floatformat:0 }}</strong>
                                </div>
                                <div>Paid: UGX {{ request.chicks_paid_today|floatformat:0 }}</div>
                                <div>Balance: <span
                                        class="{% if request.chicks_balance > 0 %}text-danger{% else %}text-success{% endif %}">
                                        UGX {{ request.chicks_balance|floatformat:0 }}</span>
                                </div>
                            </td>

                            {# Picked badge + date #}
                            <td class="align-bottom">
                                {% if request.is_picked %}
                                <span class="badge badge-primary badge-fixed">Picked</span>
                                <div class="small text-muted">{{ request.picked_on|date:"M d, Y" }}</div>
                                {% else %}
                                <span class="badge badge-success badge-fixed">Approved</span>
                                {% endif %}
                            </td>

                            {# Feeds allocation + due status #}
                            <td>
                                {% if request.feeds_allocated_bags %}
                                <div>{{ request.feeds_allocated_bags }} bag{{ request.feeds_allocated_bags|pluralize }}
                                </div>
                                {% if request.feeds_due_date %}
                                <div class="small text-muted">Due: {{ request.feeds_due_date|date:"M d, Y" }}</div>
                                {% endif %}
                                <div>
                                    {% if request.feeds_status == 'paid' %}
                                    <span class="badge badge-success badge-fixed">Paid</span>
                                    {% elif request.feeds_status == 'overdue' %}
                                    <span class="badge badge-danger badge-fixed">Overdue</span>
                                    {% elif request.feeds_status == 'due' %}
                                    <span class="badge badge-warning badge-fixed">Due</span>
                                    {% else %}
                                    <span class="text-muted small">‚Äî</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>

                            <td class="notes-preview align-bottom">
                                {% with note=request.pickup_notes|default:request.notes %}
                                {% if note %}
                                {{ note|truncatechars:40 }}
                                {% if note|length > 40 %}
                                <a href="#" class="ml-1" data-toggle="modal"
                                    data-target="#noteModal{{ request.id }}">More‚Ä¶</a>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                                {% endwith %}
                            </td>



                            <td class="align-bottom">{{ request.submitted_on|date:"M d, Y" }}</td>
                        </tr>
                        {% with note=request.pickup_notes|default:request.notes %}
                        <div class="modal fade" id="noteModal{{ request.id }}" tabindex="-1" role="dialog"
                            aria-labelledby="noteModalLabel{{ request.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-scrollable modal-md" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="noteModalLabel{{ request.id }}">
                                            Notes ‚Äî {{ request.farmer.name }} (REQ{{ request.id }})
                                        </h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        {% if note %}
                                        <div style="white-space:pre-wrap">{{ note }}</div>
                                        {% else %}
                                        <span class="text-muted">No notes.</span>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endwith %}


                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">No historical records yet.</td>
                        </tr>
                        {% with note=request.pickup_notes|default:request.notes %}
                        <div class="modal fade" id="noteModal{{ request.id }}" tabindex="-1" role="dialog"
                            aria-labelledby="noteModalLabel{{ request.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-scrollable modal-md" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="noteModalLabel{{ request.id }}">
                                            Notes ‚Äî {{ request.farmer.name }} (REQ{{ request.id }})
                                        </h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        {% if note %}
                                        <div style="white-space:pre-wrap">{{ note }}</div>
                                        {% else %}
                                        <span class="text-muted">No notes.</span>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endwith %}

                        {% endfor %}
                    </tbody>
                </table>


            </div>
        </div>
    </div>

</div>
{% endblock %}